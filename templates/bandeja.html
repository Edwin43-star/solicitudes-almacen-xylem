<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bandeja - Solicitudes AlmacÃ©n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f6f7fb; }
    .card-header small { opacity: 0.85; }
    .badge-estado { font-size: 0.85rem; padding: .45em .7em; }
    .tabla-items td { vertical-align: middle; }
    .codigo {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.92rem;
    }
    .titulo {
      font-weight: 700;
      letter-spacing: 0.2px;
    }
  </style>
</head>

<body>

<div class="container py-4">

  <!-- CABECERA -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <span style="font-size:1.7rem;">ðŸ“¥</span>
      <h3 class="m-0 titulo">Bandeja de Solicitudes</h3>
    </div>
    <a href="/logout" class="btn btn-outline-danger btn-sm">Cerrar sesiÃ³n</a>
  </div>

  <!-- ALERTAS -->
  {% with mensajes = get_flashed_messages(with_categories=true) %}
    {% if mensajes %}
      {% for cat, msg in mensajes %}
        <div class="alert alert-{{ cat }} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if solicitudes|length == 0 %}
    <div class="alert alert-warning">
      No hay solicitudes registradas aÃºn.
    </div>
  {% endif %}

  <!-- LISTA DE SOLICITUDES -->
  {% for sol in solicitudes %}

    {% set est = (sol.estado or "")|upper %}
    {% set nitems = sol.detalle|length %}

    <div class="card shadow-sm mb-4">

      <!-- HEADER SOLICITUD -->
      <div class="card-header bg-dark text-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

          <div>
            <div class="fw-bold">
              ðŸ†” ID: {{ sol.id_solicitud }}
              <span class="text-white-50 fw-normal"> ({{ nitems }} item{% if nitems != 1 %}s{% endif %})</span>
            </div>
            <small>
              ðŸ“… {{ sol.fecha }} &nbsp; | &nbsp;
              ðŸ‘¤ {{ sol.solicitante }} &nbsp; | &nbsp;
              ðŸ“¦ {{ sol.tipo }}
            </small>
          </div>

          <!-- BOTONES / ESTADO -->
          <div class="d-flex gap-2 align-items-center">

            <!-- BOTÃ“N GENERAR VALE (deshabilitado si ATENDIDO) -->
            {% if est == "ATENDIDO" %}
              <button class="btn btn-secondary btn-sm" disabled
                      title="Esta solicitud ya fue atendida">
                âœ… YA ATENDIDO
              </button>
            {% else %}
              <form action="/generar_vale/{{ sol.id_solicitud }}" method="POST" class="m-0">
                <button class="btn btn-warning btn-sm">
                  ðŸ§¾ GENERAR VALE
                </button>
              </form>
            {% endif %}

            <!-- BADGE ESTADO -->
            {% if est == "PENDIENTE" %}
              <span class="badge bg-warning text-dark badge-estado">PENDIENTE</span>
            {% elif est == "ATENDIDO" %}
              <span class="badge bg-success badge-estado">ATENDIDO</span>
            {% elif est == "ANULADO" %}
              <span class="badge bg-danger badge-estado">ANULADO</span>
            {% else %}
              <span class="badge bg-info badge-estado">{{ sol.estado }}</span>
            {% endif %}

          </div>
        </div>
      </div>

      <!-- BODY -->
      <div class="card-body">

        <!-- TABLA ITEMS -->
        <div class="table-responsive">
          <table class="table table-bordered table-sm tabla-items">
            <thead class="table-secondary">
              <tr>
                <th style="width:130px;">COD SAP</th>
                <th style="width:190px;">COD BARRAS</th>
                <th>DESCRIPCIÃ“N</th>
                <th style="width:80px;" class="text-center">U.M</th>
                <th style="width:80px;" class="text-center">CANT</th>
                <th style="width:120px;" class="text-center">ESTADO</th>
              </tr>
            </thead>

            <tbody>
              <!-- âœ… IMPORTANTE: sol.detalle -->
              {% for it in sol.detalle %}
              {% set eit = (it.estado or "")|upper %}
              <tr>
                <td class="codigo">{{ it.codigo_sap }}</td>
                <td class="codigo">{{ it.codigo_barras }}</td>
                <td>{{ it.descripcion }}</td>
                <td class="text-center">{{ it.um }}</td>
                <td class="text-center fw-bold">{{ it.cantidad }}</td>

                <td class="text-center">
                  {% if eit == "PENDIENTE" %}
                    <span class="badge bg-warning text-dark">PENDIENTE</span>
                  {% elif eit == "ATENDIDO" %}
                    <span class="badge bg-success">ATENDIDO</span>
                  {% elif eit == "ANULADO" %}
                    <span class="badge bg-danger">ANULADO</span>
                  {% else %}
                    <span class="badge bg-info">{{ it.estado }}</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>

        <!-- PIE -->
        <div class="d-flex justify-content-end">
          <small class="text-muted">
            ðŸ‘· Almacenero: <strong>{{ sol.almacenero }}</strong>
          </small>
        </div>

      </div>
    </div>

  {% endfor %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>