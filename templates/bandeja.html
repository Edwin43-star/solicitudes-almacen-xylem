{% extends "base.html" %}
{% block content %}

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">üì• Bandeja de Solicitudes</h2>
    <a href="/logout" class="btn btn-outline-danger">Cerrar sesi√≥n</a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="alert alert-{{cat}} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% for sol in solicitudes %}
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-dark text-white">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

        <div>
          <div class="fw-bold fs-5">
            <span class="badge bg-primary me-2">ID</span> {{ sol.id_solicitud }}
            <span class="text-white-50 ms-2">({{ sol.detalle|length }} items)</span>
          </div>
          <div class="text-white-50 mt-1">
            üóì {{ sol.fecha }} &nbsp; | &nbsp;
            üë§ {{ sol.solicitante }} &nbsp; | &nbsp;
            üì¶ {{ sol.tipo }}
          </div>
        </div>

        <div class="d-flex gap-2 align-items-center">

          {% set est = (sol.estado or "")|upper %}
          {% if est == "ATENDIDO" %}
            <a class="btn btn-primary btn-sm" href="{{ vale_url }}" target="_blank">
              üìÑ VER VALE
            </a>
            <span class="badge bg-success px-3 py-2">ATENDIDO</span>
          {% else %}
            <form action="/generar_vale/{{ sol.id_solicitud }}" method="POST" class="m-0">
              <button class="btn btn-warning btn-sm">
                üìÑ GENERAR VALE
              </button>
            </form>
            <span class="badge bg-warning text-dark px-3 py-2">PENDIENTE</span>
          {% endif %}

        </div>
      </div>
    </div>

    <div class="card-body">

      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>COD SAP</th>
              <th>COD BARRAS</th>
              <th>DESCRIPCI√ìN</th>
              <th class="text-center">U.M</th>
              <th class="text-center">CANT</th>
              <th class="text-center">ESTADO</th>
            </tr>
          </thead>
          <tbody>
            {% for it in sol.detalle %}
            <tr>
              <td style="min-width:160px;">{{ it.codigo_sap }}</td>
              <td style="min-width:160px;">{{ it.codigo_barras }}</td>
              <td>{{ it.descripcion }}</td>
              <td class="text-center" style="width:90px;">{{ it.um }}</td>
              <td class="text-center" style="width:80px;"><b>{{ it.cantidad }}</b></td>
              <td class="text-center" style="width:120px;">
                {% set e = (it.estado or "")|upper %}
                {% if e == "ATENDIDO" %}
                  <span class="badge bg-success">ATENDIDO</span>
                {% else %}
                  <span class="badge bg-warning text-dark">PENDIENTE</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-2 text-end text-muted small">
        üßë‚Äçüíº Almacenero: <b>{{ sol.almacenero }}</b>
      </div>

    </div>
  </div>
  {% endfor %}

</div>

{% endblock %}
