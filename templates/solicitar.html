<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Solicitud de Almacén</title>
</head>
<body>

<h2>Solicitud de Almacén</h2>

<form method="POST" action="/enviar">

<label>Usuario</label><br>
<input type="text" name="usuario" required><br><br>

<label>Tipo</label><br>
<select name="tipo" id="tipo" required>
  <option value="">-- Seleccione --</option>
  <option value="EPP">EPP</option>
  <option value="CONSUMIBLE">CONSUMIBLE</option>
  <option value="EQUIPO">EQUIPO</option>
  <option value="HERRAMIENTA">HERRAMIENTA</option>
</select><br><br>

<label>Producto</label><br>
<select id="producto" required>
  <option value="">-- Seleccione --</option>
</select><br><br>

<input type="hidden" name="codigo" id="codigo">
<input type="hidden" name="descripcion" id="descripcion">

<label>Stock disponible</label><br>
<input type="text" id="stock" readonly><br><br>

<label>Cantidad</label><br>
<input type="number" name="cantidad" id="cantidad" min="1" required><br><br>

<button type="submit">Enviar</button>

</form>

<script>
const tipo = document.getElementById("tipo");
const producto = document.getElementById("producto");
const codigo = document.getElementById("codigo");
const descripcion = document.getElementById("descripcion");
const stock = document.getElementById("stock");
const cantidad = document.getElementById("cantidad");

let catalogo = [];

tipo.addEventListener("change", () => {
    producto.innerHTML = "<option value=''>-- Seleccione --</option>";
    stock.value = "";
    codigo.value = "";
    descripcion.value = "";

    if (!tipo.value) return;

    fetch(`/api/catalogo?tipo=${tipo.value}`)
        .then(res => res.json())
        .then(data => {
            catalogo = data;
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.codigo;
                opt.textContent = `${p.codigo} - ${p.descripcion}`;
                producto.appendChild(opt);
            });
        });
});

producto.addEventListener("change", () => {
    const p = catalogo.find(x => x.codigo === producto.value);
    if (!p) return;

    codigo.value = p.codigo;
    descripcion.value = p.descripcion;
    stock.value = p.stock;
});

cantidad.addEventListener("input", () => {
    if (parseInt(cantidad.value) > parseInt(stock.value)) {
        alert("Cantidad supera el stock disponible");
        cantidad.value = stock.value;
    }
});
</script>

</body>
</html>