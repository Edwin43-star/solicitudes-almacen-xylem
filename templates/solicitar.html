{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h3>ðŸ“¦ Nueva Solicitud</h3>

  <div class="row g-2">
    <div class="col-md-3">
      <select id="tipo" class="form-select">
        <option>EPP</option>
        <option>CONSUMIBLE</option>
        <option>EQUIPO</option>
        <option>HERRAMIENTA</option>
      </select>
    </div>

    <div class="col-md-5">
      <select id="descripcion" class="form-select"></select>
    </div>

    <div class="col-md-2">
      <input id="cantidad" type="number" value="1" class="form-control">
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100" onclick="agregar()">+</button>
    </div>
  </div>

  <hr>

  <table class="table mt-3">
    <thead>
      <tr>
        <th>Tipo</th>
        <th>DescripciÃ³n</th>
        <th>Cantidad</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>

  <button class="btn btn-success" onclick="enviar()">Enviar Solicitud</button>
</div>

<script>
let items = []

async function cargar() {
  let tipo = document.getElementById("tipo").value
  let res = await fetch(`/api/catalogo/${tipo}`)
  let data = await res.json()
  let sel = document.getElementById("descripcion")
  sel.innerHTML = ""
  data.forEach(d => sel.innerHTML += `<option>${d}</option>`)
}

document.getElementById("tipo").onchange = cargar
window.onload = cargar

function agregar() {
  items.push({
    tipo: tipo.value,
    descripcion: descripcion.value,
    cantidad: cantidad.value
  })
  render()
}

function render() {
  lista.innerHTML = ""
  items.forEach((i, idx) => {
    lista.innerHTML += `
      <tr>
        <td>${i.tipo}</td>
        <td>${i.descripcion}</td>
        <td>${i.cantidad}</td>
        <td><button class="btn btn-danger btn-sm" onclick="items.splice(${idx},1);render()">ðŸ—‘</button></td>
      </tr>`
  })
}

async function enviar() {
  await fetch("/enviar_solicitud", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({items})
  })
  alert("Solicitud enviada")
  items = []
  render()
}
</script>

{% endblock %}