<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Solicitud de Almacén</title>
<style>
#lista {
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}
#lista div {
    padding: 6px;
    cursor: pointer;
}
#lista div:hover {
    background: #eee;
}
</style>
</head>

<body>

<h2>Solicitud de Almacén</h2>

<form method="POST" action="/enviar" onsubmit="return validarStock()">

<label>Usuario</label><br>
<input type="text" name="usuario" required><br><br>

<label>Tipo</label><br>
<select id="tipo" name="tipo" required>
    <option value="">-- Seleccione --</option>
    <option value="EPP">EPP</option>
    <option value="CONSUMIBLE">CONSUMIBLE</option>
    <option value="EQUIPO">EQUIPO</option>
    <option value="HERRAMIENTA">HERRAMIENTA</option>
</select><br><br>

<label>Buscar producto</label><br>
<input type="text" id="buscador" autocomplete="off">
<div id="lista"></div><br>

<strong>Stock disponible: <span id="stock">-</span></strong><br><br>

<input type="hidden" name="codigo" id="codigo">
<input type="hidden" name="descripcion" id="descripcion">

<label>Cantidad</label><br>
<input type="number" name="cantidad" id="cantidad" min="1" value="1" required><br><br>

<button type="submit">Enviar</button>

</form>

<script>
let catalogo = [];
let stockActual = 0;

document.getElementById("tipo").addEventListener("change", () => {
    const tipo = document.getElementById("tipo").value;
    fetch(`/api/catalogo?tipo=${tipo}`)
        .then(r => r.json())
        .then(data => catalogo = data);
});

document.getElementById("buscador").addEventListener("input", () => {
    const texto = buscador.value.toLowerCase();
    lista.innerHTML = "";
    lista.style.display = "block";

    catalogo
        .filter(i => i.descripcion.toLowerCase().includes(texto))
        .slice(0, 10)
        .forEach(i => {
            const div = document.createElement("div");
            div.textContent = `${i.codigo} - ${i.descripcion}`;
            div.onclick = () => seleccionar(i);
            lista.appendChild(div);
        });
});

function seleccionar(item) {
    buscador.value = item.descripcion;
    codigo.value = item.codigo;
    descripcion.value = item.descripcion;
    stock.textContent = item.stock;
    stockActual = item.stock;
    lista.style.display = "none";
}

function validarStock() {
    const cant = parseInt(document.getElementById("cantidad").value);
    if (cant > stockActual) {
        alert("Cantidad mayor al stock disponible");
        return false;
    }
    return true;
}
</script>

</body>
</html>