{% extends "base.html" %}
{% block title %}Nueva Solicitud{% endblock %}

{% block content %}
<div class="container mt-4">

  <h3 class="mb-4">
    <i class="bi bi-box-seam"></i> Nueva Solicitud
  </h3>

  <!-- FORMULARIO -->
  <div class="card p-3 mb-4 shadow-sm">
    <div class="row g-2 align-items-end">

      <div class="col-md-3">
        <label class="form-label">Tipo</label>
        <select id="tipo" class="form-select">
          <option value="EPP">EPP</option>
          <option value="CONSUMIBLE">CONSUMIBLE</option>
          <option value="EQUIPO">EQUIPO</option>
          <option value="HERRAMIENTA">HERRAMIENTA</option>
        </select>
      </div>

      <div class="col-md-5">
        <label class="form-label">Descripci贸n</label>
        <select id="descripcion" class="form-select">
          <option value="">Seleccione...</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Cantidad</label>
        <input type="number" id="cantidad" class="form-control" value="1" min="1">
      </div>

      <div class="col-md-2">
        <button class="btn btn-primary w-100" onclick="agregarItem()">
          <i class="bi bi-plus-lg"></i>
        </button>
      </div>

    </div>
  </div>

  <!-- TABLA ITEMS -->
  <div class="card shadow-sm">
    <div class="card-header">
      <i class="bi bi-list-check"></i> tems Agregados
    </div>

    <div class="card-body p-0">
      <table class="table table-striped mb-0">
        <thead class="table-light">
          <tr>
            <th>Tipo</th>
            <th>Descripci贸n</th>
            <th class="text-center">Cantidad</th>
            <th class="text-center">Acci贸n</th>
          </tr>
        </thead>
        <tbody id="tablaItems">
          <tr>
            <td colspan="4" class="text-center text-muted">
              No hay 铆tems agregados.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ENVIAR -->
  <div class="text-end mt-3">
    <button class="btn btn-success" onclick="enviarSolicitud()">
      <i class="bi bi-send"></i> Enviar Solicitud
    </button>
  </div>

</div>

<script>
let items = [];
let catalogo = {};

// ==============================
// CARGAR CATLOGO DESDE BACKEND
// ==============================
fetch("/api/catalogo")
  .then(r => r.json())
  .then(data => {
    catalogo = data;
    cargarDescripciones();
  });

document.getElementById("tipo").addEventListener("change", cargarDescripciones);

function cargarDescripciones() {
  const tipo = document.getElementById("tipo").value;
  const sel = document.getElementById("descripcion");
  sel.innerHTML = '<option value="">Seleccione...</option>';

  if (catalogo[tipo]) {
    catalogo[tipo].forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      sel.appendChild(opt);
    });
  }
}

// ==============================
// AGREGAR ITEM
// ==============================
function agregarItem() {
  const tipo = document.getElementById("tipo").value;
  const desc = document.getElementById("descripcion").value;
  const cant = document.getElementById("cantidad").value;

  if (!desc || cant <= 0) {
    alert("Complete descripci贸n y cantidad");
    return;
  }

  items.push({
    tipo: tipo,
    descripcion: desc,
    cantidad: cant
  });

  renderTabla();
}

// ==============================
// ELIMINAR ITEM
// ==============================
function eliminarItem(index) {
  items.splice(index, 1);
  renderTabla();
}

// ==============================
// RENDER TABLA
// ==============================
function renderTabla() {
  const tbody = document.getElementById("tablaItems");
  tbody.innerHTML = "";

  if (items.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center text-muted">
          No hay 铆tems agregados.
        </td>
      </tr>`;
    return;
  }

  items.forEach((it, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${it.tipo}</td>
        <td>${it.descripcion}</td>
        <td class="text-center">${it.cantidad}</td>
        <td class="text-center">
          <button class="btn btn-sm btn-danger" onclick="eliminarItem(${i})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`;
  });
}

// ==============================
// ENVIAR SOLICITUD
// ==============================
function enviarSolicitud() {
  if (items.length === 0) {
    alert("No hay 铆tems para enviar");
    return;
  }

  fetch("/enviar_solicitud", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ items: items })
  })
  .then(r => r.json())
  .then(resp => {
    alert("Solicitud enviada correctamente");
    items = [];
    renderTabla();
  });
}
</script>
{% endblock %}

<script>
let catalogo = [];
let items = [];

async function cargarCatalogo() {
    const res = await fetch("/api/catalogo");
    catalogo = await res.json();
}

document.getElementById("tipo").addEventListener("change", function () {
    const tipo = this.value;
    const sel = document.getElementById("descripcion");
    sel.innerHTML = '<option value="">Seleccione...</option>';

    catalogo
        .filter(i => i.Tipo.toUpperCase() === tipo.toUpperCase())
        .forEach(i => {
            const opt = document.createElement("option");
            opt.value = i.Descripcion;
            opt.textContent = i.Descripcion;
            sel.appendChild(opt);
        });
});

document.getElementById("btnAgregar").addEventListener("click", () => {
    const tipo = tipoSelect.value;
    const descripcion = descripcionSelect.value;
    const cantidad = cantidadInput.value;

    if (!descripcion) return alert("Seleccione un producto");

    items.push({ tipo, descripcion, cantidad });
    renderItems();
});

function renderItems() {
    const tbody = document.getElementById("tablaItems");
    tbody.innerHTML = "";

    items.forEach((i, idx) => {
        tbody.innerHTML += `
        <tr>
            <td>${i.tipo}</td>
            <td>${i.descripcion}</td>
            <td>${i.cantidad}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminar(${idx})">
                    
                </button>
            </td>
        </tr>`;
    });
}

function eliminar(i) {
    items.splice(i, 1);
    renderItems();
}

document.getElementById("btnEnviar").addEventListener("click", async () => {
    if (items.length === 0) return alert("No hay items para enviar");

    await fetch("/enviar_solicitud", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items })
    });

    alert("Solicitud enviada");
    location.reload();
});

cargarCatalogo();
</script>