<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nueva Solicitud</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .topbar { background:#0d6efd; color:#fff; }
    .topbar .brand { font-weight:700; font-size:1.4rem; }
  </style>
</head>
<body class="bg-light">

  <div class="topbar py-3">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="brand">Xylem</div>
      <div class="d-flex gap-2 align-items-center">
        <span class="badge bg-light text-dark">{{ user_name }}</span>
        <a class="btn btn-outline-light btn-sm" href="/logout">Salir</a>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <h2 class="mb-4">Nueva Solicitud</h2>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Tipo</label>
            <select id="tipo" class="form-select">
              <option value="EPP">EPP</option>
              <option value="CONSUMIBLE">CONSUMIBLE</option>
              <option value="EQUIPO">EQUIPO</option>
              <option value="HERRAMIENTA">HERRAMIENTA</option>
            </select>
          </div>

          <div class="col-12 col-md-5">
            <label class="form-label">Descripci√≥n</label>
            <select id="descripcion" class="form-select">
              <option value="">Cargando cat√°logo...</option>
            </select>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Cantidad</label>
            <input id="cantidad" type="number" class="form-control" value="1" min="1">
          </div>

          <div class="col-12 col-md-2 d-grid">
            <button id="btnAdd" class="btn btn-primary">+</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">√çtems Agregados</h5>

        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Tipo</th>
                <th>Descripci√≥n</th>
                <th style="width:140px;">Cantidad</th>
                <th style="width:120px;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="4" class="text-center text-muted">No hay √≠tems agregados.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end">
          <button id="btnEnviar" class="btn btn-success">Enviar Solicitud</button>
        </div>
      </div>
    </div>
  </div>

<script>
  let catalogo = [];
  let items = [];

  const tipoEl = document.getElementById("tipo");
  const descEl = document.getElementById("descripcion");
  const cantEl = document.getElementById("cantidad");
  const tbody = document.getElementById("tbody");

  function renderTabla() {
    tbody.innerHTML = "";

    if (items.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No hay √≠tems agregados.</td></tr>`;
      return;
    }

    items.forEach((it, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.tipo}</td>
        <td>${it.descripcion}</td>
        <td class="text-center">${it.cantidad}</td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm" data-idx="${idx}">üóë</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-idx]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = parseInt(btn.getAttribute("data-idx"));
        items.splice(i, 1);
        renderTabla();
      });
    });
  }

  function cargarOpciones() {
    const tipo = tipoEl.value;
    const filtrados = catalogo.filter(x => (x.tipo || "").toUpperCase() === tipo);

    descEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Seleccione...";
    descEl.appendChild(opt0);

    filtrados.forEach(x => {
      const opt = document.createElement("option");
      opt.value = x.descripcion;
      opt.textContent = x.descripcion;
      descEl.appendChild(opt);
    });

    if (filtrados.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No hay √≠tems en cat√°logo para este tipo";
      descEl.appendChild(opt);
    }
  }

  async function cargarCatalogo() {
    const res = await fetch("/api/catalogo");
    const data = await res.json();

    if (!data.ok) {
      descEl.innerHTML = `<option value="">Error cargando cat√°logo: ${data.error}</option>`;
      return;
    }

    catalogo = data.items || [];
    cargarOpciones();
  }

  document.getElementById("btnAdd").addEventListener("click", () => {
    const tipo = tipoEl.value;
    const descripcion = descEl.value;
    let cantidad = parseInt(cantEl.value || "1");

    if (!descripcion) {
      alert("Seleccione un √≠tem del cat√°logo.");
      return;
    }
    if (!cantidad || cantidad < 1) cantidad = 1;

    items.push({ tipo, descripcion, cantidad });
    renderTabla();
  });

  document.getElementById("btnEnviar").addEventListener("click", async () => {
    if (items.length === 0) {
      alert("No hay √≠tems para enviar");
      return;
    }

    const res = await fetch("/api/guardar_solicitud", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items })
    });

    const data = await res.json();
    if (!data.ok) {
      alert("Error: " + data.error);
      return;
    }

    items = [];
    renderTabla();
    alert("Solicitud enviada ‚úÖ");
  });

  tipoEl.addEventListener("change", cargarOpciones);
  cargarCatalogo();
</script>

</body>
</html>