{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center gap-2 mb-3">
  <i class="bi bi-box-seam fs-2"></i>
  <h2 class="m-0 fw-bold">Nueva Solicitud</h2>
</div>

<div class="card shadow-sm border-0 rounded-4 mb-4">
  <div class="card-body p-3 p-md-4">
    <div class="row g-3 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label">Tipo</label>
        <select id="tipo" class="form-select">
          <option value="EPP">EPP</option>
          <option value="CONSUMIBLE">CONSUMIBLE</option>
          <option value="EQUIPOS Y HERRAMIENTAS">EQUIPOS Y HERRAMIENTAS</option>
        </select>
      </div>

      <div class="col-12 col-md-5">
        <label class="form-label">Descripción</label>
        <select id="descripcion" class="form-select">
          <option value="">Cargando catálogo...</option>
        </select>
      </div>

      <div class="col-12 col-md-2">
        <label class="form-label">Cantidad</label>
        <input id="cantidad" type="number" class="form-control" value="1" min="1">
      </div>

      <div class="col-12 col-md-2 d-grid">
        <button id="btnAdd" class="btn btn-primary py-2">
          <i class="bi bi-plus-lg"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-header bg-white border-0 pt-3 px-3 px-md-4">
    <h5 class="m-0 fw-bold"><i class="bi bi-list-check me-2"></i>Ítems Agregados</h5>
  </div>
  <div class="card-body px-3 px-md-4 pb-4">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Tipo</th>
            <th>Descripción</th>
            <th class="text-center">Cantidad</th>
            <th class="text-center">Acción</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr id="emptyRow">
            <td colspan="4" class="text-center text-muted py-4">No hay ítems agregados.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end">
      <button id="btnEnviar" class="btn btn-success px-4 py-2">
        <i class="bi bi-send me-2"></i>Enviar Solicitud
      </button>
    </div>
  </div>
</div>

<script>
  let catalogo = {};
  let items = [];

  const tipoEl = document.getElementById("tipo");
  const descEl = document.getElementById("descripcion");
  const cantEl = document.getElementById("cantidad");
  const tbody = document.getElementById("tbody");
  const emptyRow = document.getElementById("emptyRow");

  function renderItems() {
    // limpiar tbody y volver a poner emptyRow si no hay items
    tbody.innerHTML = "";
    if (items.length === 0) {
      tbody.appendChild(emptyRow);
      return;
    }

    items.forEach((it, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.tipo}</td>
        <td>${it.descripcion}</td>
        <td class="text-center">${it.cantidad}</td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm" onclick="removeItem(${idx})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function removeItem(i) {
    items.splice(i, 1);
    renderItems();
  }

  function cargarOpciones() {
    const t = (tipoEl.value || "").toUpperCase();
    const lista = catalogo[t] || [];

    descEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Seleccione...";
    descEl.appendChild(opt0);

    lista.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      descEl.appendChild(opt);
    });
  }

  async function fetchCatalogo() {
    try {
      const res = await fetch("/api/catalogo");
      const data = await res.json();
      if (!data.ok) {
        descEl.innerHTML = `<option value="">ERROR: ${data.error}</option>`;
        return;
      }
      catalogo = data.catalogo || {};
      cargarOpciones();
    } catch (e) {
      descEl.innerHTML = `<option value="">ERROR cargando catálogo</option>`;
    }
  }

  document.getElementById("btnAdd").addEventListener("click", () => {
    const tipo = (tipoEl.value || "").toUpperCase();
    const descripcion = (descEl.value || "").toUpperCase().trim();
    const cantidad = parseInt(cantEl.value || "1", 10);

    if (!descripcion) {
      alert("Seleccione un producto.");
      return;
    }
    if (!cantidad || cantidad < 1) {
      alert("Cantidad inválida.");
      return;
    }

    items.push({ tipo, descripcion, cantidad });
    renderItems();
  });

  tipoEl.addEventListener("change", cargarOpciones);

  document.getElementById("btnEnviar").addEventListener("click", async () => {
    if (items.length === 0) {
      alert("No hay ítems para enviar");
      return;
    }
    try {
      const res = await fetch("/enviar_solicitud", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ items })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Error: " + data.error);
        return;
      }
      items = [];
      renderItems();
      alert("Solicitud enviada ✅");
    } catch (e) {
      alert("Error enviando solicitud.");
    }
  });

  // init
  fetchCatalogo();
  renderItems();
</script>

{% endblock %}