{% extends "base.html" %}

{% block title %}Nueva Solicitud{% endblock %}

{% block content %}
<h2>Nueva Solicitud</h2>

<form method="POST" action="/enviar" class="form-card">

    <label>Usuario</label>
    <input type="text" name="usuario" required placeholder="Ingrese su nombre">

    <label>Tipo</label>
    <select name="tipo" id="tipo" required>
        <option value="">-- Seleccione --</option>
        <option value="EPP">EPP</option>
        <option value="CONSUMIBLE">Consumible</option>
        <option value="HERRAMIENTA">Herramienta</option>
        <option value="EQUIPO">Equipo</option>
    </select>

    <label>Producto</label>
    <select id="producto" required>
        <option value="">Seleccione un producto</option>
    </select>

    <!-- Campos ocultos que viajan al backend -->
    <input type="hidden" name="codigo" id="codigo">
    <input type="hidden" name="descripcion" id="descripcion">

    <div class="stock-box" id="stockBox" style="display:none;">
        Stock disponible: <strong id="stock"></strong>
    </div>

    <label>Cantidad</label>
    <input type="number" name="cantidad" id="cantidad" min="1" required>

    <button type="submit">Enviar Solicitud</button>
</form>

<script>
const tipo = document.getElementById("tipo");
const producto = document.getElementById("producto");
const codigo = document.getElementById("codigo");
const descripcion = document.getElementById("descripcion");
const stockBox = document.getElementById("stockBox");
const stockSpan = document.getElementById("stock");

tipo.addEventListener("change", () => {
    producto.innerHTML = "<option> Cargando...</option>";
    fetch(`/api/catalogo?tipo=${tipo.value}`)
        .then(r => r.json())
        .then(data => {
            producto.innerHTML = "<option value=''>Seleccione</option>";
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.codigo;
                opt.textContent = `${p.codigo} - ${p.descripcion}`;
                opt.dataset.descripcion = p.descripcion;
                opt.dataset.stock = p.stock;
                producto.appendChild(opt);
            });
        });
});

producto.addEventListener("change", () => {
    const opt = producto.selectedOptions[0];
    codigo.value = opt.value;
    descripcion.value = opt.dataset.descripcion;
    stockSpan.textContent = opt.dataset.stock;
    stockBox.style.display = "block";
});
</script>
{% endblock %}