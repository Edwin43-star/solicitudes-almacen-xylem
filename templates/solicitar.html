<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Nueva Solicitud</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

body{
    font-family: Arial;
    margin:20px;
}

.container{
    max-width:900px;
    margin:auto;
}

.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.row{
    display:flex;
    gap:10px;
    margin-bottom:10px;
}

input, select, button{
    padding:8px;
    font-size:14px;
}

button{
    cursor:pointer;
}

#lista_autocomplete{
    border:1px solid #ccc;
    max-height:200px;
    overflow-y:auto;
    display:none;
    position:absolute;
    background:white;
    width:100%;
    z-index:999;
}

.item_autocomplete{
    padding:6px;
    border-bottom:1px solid #eee;
}

.item_autocomplete:hover{
    background:#007bff;
    color:white;
    cursor:pointer;
}

table{
    width:100%;
    border-collapse:collapse;
}

th, td{
    border:1px solid #ccc;
    padding:6px;
}

.btn-remove{
    background:red;
    color:white;
    border:none;
    padding:4px 8px;
}

.btn-add{
    background:green;
    color:white;
    border:none;
}

.btn-send{
    background:#007bff;
    color:white;
    border:none;
    padding:10px;
}

.btn-salir{
    background:#6c757d;
    color:white;
    border:none;
    padding:8px 15px;
}

</style>

</head>
<body>

<div class="container">

<div class="header">

<div>
<h2>Nueva Solicitud</h2>
<p>Solicitante: <b>{{ session.nombre }}</b></p>
</div>

<div>
<button class="btn-salir" onclick="salir()">Salir</button>
</div>

</div>


<div class="row">

<select id="tipo">
<option value="">Seleccione...</option>

<!-- SOLO ESTOS DOS -->
<option value="EPP">EPP</option>
<option value="CONSUMIBLE">CONSUMIBLE</option>

</select>


<div style="position:relative; width:100%;">

<input type="text" id="buscar" placeholder="Escriba el artÃ­culo...">

<div id="lista_autocomplete"></div>

</div>


<input type="number" id="cantidad" value="1" min="1">

<button class="btn-add" onclick="agregarItem()">+ Agregar item</button>

</div>


<h3>Items a solicitar</h3>

<table id="tabla">

<thead>
<tr>
<th>Tipo</th>
<th>DescripciÃ³n</th>
<th>U.M</th>
<th>Cantidad</th>
</tr>
</thead>

<tbody></tbody>

</table>


<br>


<form method="POST" action="/guardar_solicitud" onsubmit="return enviar()">

<input type="hidden" name="items_json" id="items_json">

<button class="btn-send">Enviar solicitud</button>

</form>


</div>


<script>

let catalogo=[]
let items=[]


// ===============================
// BOTON SALIR
// ===============================
function salir(){

window.location.href="/logout"

}


// ===============================
// CARGAR CATALOGO SEGUN TIPO
// ===============================
document.getElementById("tipo").addEventListener("change", async function(){

let tipo=this.value

if(!tipo)return

let res=await fetch("/api/catalogo?tipo="+tipo)

let data=await res.json()

catalogo=data.items || []

})


// ===============================
// AUTOCOMPLETE BUSQUEDA
// ===============================
document.getElementById("buscar").addEventListener("input", function(){

let texto=this.value.toLowerCase()

let lista=document.getElementById("lista_autocomplete")

lista.innerHTML=""

if(texto.length<2){

lista.style.display="none"

return

}

let resultados=catalogo.filter(x=>

(x.descripcion || "").toLowerCase().includes(texto)

)

resultados.slice(0,20).forEach(item=>{

let div=document.createElement("div")

div.className="item_autocomplete"

// ðŸ”¹ MOSTRAR DESCRIPCIÃ“N + UNIDAD
div.innerHTML = `
  ${item.descripcion}
  <span style="float:right; font-weight:bold; color:#555;">(${item.um || ""})</span>
`

div.onclick=function(){
    document.getElementById("buscar").value=item.descripcion
    document.getElementById("buscar").dataset.um = item.um || ""
    lista.style.display="none"
}

lista.appendChild(div)

})

lista.style.display="block"

})


// ===============================
// AGREGAR ITEM
// ===============================
function agregarItem(){

let tipo=document.getElementById("tipo").value
let descripcion=document.getElementById("buscar").value
let cantidad=document.getElementById("cantidad").value
let um=document.getElementById("buscar").dataset.um || ""

if(!tipo || !descripcion || !cantidad){
    alert("Complete los datos")
    return
}

items.push({
    tipo:tipo,
    descripcion:descripcion,
    cantidad:cantidad,
    um:um
})

render()

document.getElementById("buscar").value=""
document.getElementById("cantidad").value=1
document.getElementById("buscar").dataset.um=""
}


// ===============================
// RENDER TABLA
// ===============================
function render(){

let tbody=document.querySelector("#tabla tbody")

tbody.innerHTML=""

items.forEach((item,index)=>{

let tr=document.createElement("tr")

tr.innerHTML=`
<td>${item.tipo}</td>
<td>${item.descripcion}</td>
<td style="text-align:center;"><b>${item.um || ""}</b></td>
<td>${item.cantidad}</td>
<td>
<button class="btn-remove" onclick="eliminar(${index})">
Quitar
</button>
</td>
`

tbody.appendChild(tr)

})

}


// ===============================
// ELIMINAR ITEM
// ===============================
function eliminar(i){

items.splice(i,1)

render()

}


// ===============================
// ENVIAR
// ===============================
function enviar(){

if(items.length==0){

alert("Agregue items")

return false

}

document.getElementById("items_json").value=JSON.stringify(items)

return true

}

</script>


</body>
</html>