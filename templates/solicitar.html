{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h4 class="mb-0">Nueva Solicitud</h4>
    <div class="text-muted">Solicitante: <b>{{ session.get("nombre", "") }}</b></div>
  </div>

  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('inicio') }}">
    Nueva solicitud
  </a>
</div>

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="card shadow-sm border-0">
  <div class="card-body">

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Tipo</label>
        <select class="form-select" id="tipo" required>
          <option value="">Seleccione...</option>
          <option value="EPP">EPP</option>
          <option value="CONSUMIBLE">CONSUMIBLE</option>
          <option value="EQUIPO">EQUIPO</option>
          <option value="HERRAMIENTA">HERRAMIENTA</option>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Artículo</label>
        <select class="form-select" id="articulo" disabled required>
          <option value="">Seleccione tipo primero</option>
        </select>
        <div class="form-text" id="stockHelp"></div>
      </div>

      <div class="col-md-2">
        <label class="form-label">Cant.</label>
        <input type="number" class="form-control" id="cantidad" min="1" value="1" disabled>
      </div>

      <div class="col-12 d-flex justify-content-end">
        <button class="btn btn-success" id="btnAgregar" type="button" disabled>
          + Agregar ítem
        </button>
      </div>
    </div>

    <hr class="my-4">

    <h6 class="mb-3">Ítems a solicitar</h6>

    <div class="table-responsive">
      <table class="table table-sm align-middle" id="tablaItems">
        <thead class="table-light">
          <tr>
            <th style="width: 18%">Tipo</th>
            <th>Descripción</th>
            <th style="width: 12%">Stock</th>
            <th style="width: 12%">Cantidad</th>
            <th style="width: 10%"></th>
          </tr>
        </thead>
        <tbody>
          <tr id="filaVacia">
            <td colspan="5" class="text-muted">Aún no agregas ítems.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end mt-3">
      <form method="post" action="{{ url_for('guardar_solicitud') }}" onsubmit="return prepararEnvio();">
        <input type="hidden" name="items_json" id="items_json">
        <button class="btn btn-primary" id="btnEnviar" disabled>
          Enviar solicitud
        </button>
      </form>
    </div>

  </div>
</div>

<script>
let catalogoActual = [];   // [{descripcion, stock}]
let items = [];            // [{tipo, descripcion, stock, cantidad}]

const tipoEl = document.getElementById("tipo");
const articuloEl = document.getElementById("articulo");
const cantidadEl = document.getElementById("cantidad");
const btnAgregar = document.getElementById("btnAgregar");
const btnEnviar = document.getElementById("btnEnviar");
const stockHelp = document.getElementById("stockHelp");

tipoEl.addEventListener("change", async () => {
  const tipo = tipoEl.value;
  resetSelector();

  if (!tipo) return;

  try {
    const r = await fetch(`/api/catalogo?tipo=${encodeURIComponent(tipo)}`);
    const data = await r.json();

    catalogoActual = (data.items || []);
    articuloEl.innerHTML = "<option value=''>Seleccione...</option>";

    catalogoActual.forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.descripcion;
      opt.textContent = it.descripcion;
      opt.dataset.stock = (it.stock ?? "");
      articuloEl.appendChild(opt);
    });

    articuloEl.disabled = false;
    cantidadEl.disabled = false;
    btnAgregar.disabled = false;
  } catch (e) {
    articuloEl.innerHTML = "<option value=''>Error cargando catálogo</option>";
  }
});

articuloEl.addEventListener("change", () => {
  const selected = articuloEl.options[articuloEl.selectedIndex];
  const stock = selected?.dataset?.stock ?? "";
  stockHelp.textContent = stock !== "" ? `Stock disponible: ${stock}` : "";
});

btnAgregar.addEventListener("click", () => {
  const tipo = tipoEl.value;
  const desc = articuloEl.value;
  const cant = parseInt(cantidadEl.value || "0", 10);

  if (!tipo || !desc || !cant || cant <= 0) return;

  const opt = articuloEl.options[articuloEl.selectedIndex];
  const stock = parseFloat(opt?.dataset?.stock ?? "0");

  // Validación stock (si stock viene vacío, no bloquea)
  if (!isNaN(stock) && stock > 0 && cant > stock) {
    alert(`Cantidad supera stock (${stock}).`);
    return;
  }

  // Si ya existe el mismo ítem, acumula cantidad
  const idx = items.findIndex(x => x.tipo === tipo && x.descripcion === desc);
  if (idx >= 0) {
    const nueva = items[idx].cantidad + cant;
    if (!isNaN(stock) && stock > 0 && nueva > stock) {
      alert(`Cantidad total supera stock (${stock}).`);
      return;
    }
    items[idx].cantidad = nueva;
  } else {
    items.push({ tipo, descripcion: desc, stock: isNaN(stock) ? "" : stock, cantidad: cant });
  }

  renderTabla();
  btnEnviar.disabled = items.length === 0;
});

function quitarItem(i) {
  items.splice(i, 1);
  renderTabla();
  btnEnviar.disabled = items.length === 0;
}

function renderTabla() {
  const tbody = document.querySelector("#tablaItems tbody");
  tbody.innerHTML = "";

  if (items.length === 0) {
    tbody.innerHTML = `<tr id="filaVacia"><td colspan="5" class="text-muted">Aún no agregas ítems.</td></tr>`;
    return;
  }

  items.forEach((it, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="badge bg-secondary">${it.tipo}</span></td>
      <td>${escapeHtml(it.descripcion)}</td>
      <td>${it.stock === "" ? "-" : it.stock}</td>
      <td><b>${it.cantidad}</b></td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-danger" type="button" onclick="quitarItem(${i})">
          Quitar
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function prepararEnvio() {
  if (items.length === 0) return false;
  document.getElementById("items_json").value = JSON.stringify(items);
  return true;
}

function resetSelector() {
  catalogoActual = [];
  articuloEl.innerHTML = "<option value=''>Seleccione tipo primero</option>";
  articuloEl.disabled = true;
  cantidadEl.value = 1;
  cantidadEl.disabled = true;
  btnAgregar.disabled = true;
  stockHelp.textContent = "";
}

function escapeHtml(str) {
  return (str || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
</script>

{% endblock %}